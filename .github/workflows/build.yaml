name: Q2Admin Build

on:
  push:
    branches: [master, aqtion]
  pull_request:
    branches: [master, aqtion]

jobs:
  linux_x86_64_build_q2admin:
    runs-on: [self-hosted, x86]
    steps:
      - uses: actions/checkout@v3
        with:
          repository: actionquake/q2admin
          ref: ${{ github.ref }}
          path: build
      
      - name: Set shortversion
        id: shortversion
        working-directory: build
        run: echo "::set-output name=sha_short::$(git rev-parse --short HEAD)"

      - name: luacheck - check for errors
        working-directory: build 
        run: luacheck plugins/*.lua --ignore 0 || if [ $? -eq 2 ]; then false else true; fi

      - name: Build q2admin
        working-directory: build
        run: make -j2 V=1
        env:
          CC: "gcc"
          USE_AQTION: "TRUE"

      - name: Generate archive
        uses: actions/upload-artifact@v4
        with:
          name: q2admin-lin-x86_64
          path: |
            build/gamex86_64.so
            build/plugins
            build/config.lua

  linux_arm64_build_q2admin:
    runs-on: [self-hosted, ARM64]
    steps:
      - uses: actions/checkout@v3
        with:
          repository: actionquake/q2admin
          ref: ${{ github.ref }}
          path: build

      - name: Set shortversion
        id: shortversion
        working-directory: build
        run: echo "::set-output name=sha_short::$(git rev-parse --short HEAD)"

      - name: luacheck - check for errors
        working-directory: build 
        run: luacheck plugins/*.lua --ignore 0 || if [ $? -eq 2 ]; then false else true; fi
        
      - name: Build q2admin
        working-directory: build
        run: make -j2 V=1
        env:
          CC: "gcc"
          USE_AQTION: "TRUE"

      - name: Generate archive
        uses: actions/upload-artifact@v4
        with:
          name: q2admin-lin-arm64
          path: |
            build/gamearm64.so
            build/plugins
            build/config.lua

  windows_x86_64_build_q2admin:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3
        with:
          repository: actionquake/q2admin
          ref: ${{ github.ref }}
          path: build
          
      - name: Set up MinGW
        run: |
          choco install mingw
          
      - name: Install Lua dependencies
        shell: powershell
        run: |
          choco install lua51
          choco install luarocks --params="'/MW'"
          Import-Module $env:ChocolateyInstall\helpers\chocolateyProfile.psm1
          refreshenv
          $env:LUA_INCDIR = "C:\Program Files (x86)\Lua\5.1\include"
          $env:LUA_LIBDIR = "C:\Program Files (x86)\Lua\5.1"
          luarocks config variables.CC gcc
          luarocks config variables.LD gcc
          luarocks install luacheck
          
            
      - name: Build q2admin
        working-directory: build
        run: make -j2 V=1
        env:
          CC: "x86_64-w64-mingw32-gcc"
          USE_AQTION: "TRUE"
          SHLIBEXT: "dll"
          
      - name: Generate archive
        uses: actions/upload-artifact@v4
        with:
          name: q2admin-win-x86_64
          path: |
            build/gamex86_64.dll
            build/plugins
            build/config.lua
          
